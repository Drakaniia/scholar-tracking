// Prisma Schema for Scholarship Tracking System
// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider   = "prisma-client-js"
  engineType = "js"
}

// ERD Generator - Only run locally with: npm run erd:generate
// Disabled in production builds to avoid Puppeteer/Chrome dependencies
// generator erd {
//   provider = "prisma-erd-generator"
//   output   = "../docs/ERD.svg"
//   theme    = "forest"
// }

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// USER MODEL (Authentication)
// ============================================
model User {
  id                  Int       @id @default(autoincrement()) @map("user_id")
  username            String    @unique
  email               String    @unique
  passwordHash        String    @map("password_hash")
  firstName           String    @map("first_name")
  lastName            String    @map("last_name")
  role                String    @default("STAFF") // ADMIN, STAFF, VIEWER
  status              String    @default("ACTIVE") // ACTIVE, INACTIVE, SUSPENDED
  lastLogin           DateTime? @map("last_login")
  passwordChangedAt   DateTime  @default(now()) @map("password_changed_at")
  failedLoginAttempts Int       @default(0) @map("failed_login_attempts")
  lockedUntil         DateTime? @map("locked_until")
  
  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  sessions   Session[]
  auditLogs  AuditLog[]

  @@map("users")
}

// ============================================
// SESSION MODEL
// ============================================
model Session {
  id        String   @id @map("session_id")
  userId    Int      @map("user_id")
  expiresAt DateTime @map("expires_at")
  ipAddress String?  @map("ip_address")
  userAgent String?  @map("user_agent")
  
  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

// ============================================
// AUDIT LOG MODEL
// ============================================
model AuditLog {
  id           Int      @id @default(autoincrement()) @map("log_id")
  userId       Int?     @map("user_id")
  action       String
  resourceType String?  @map("resource_type")
  resourceId   Int?     @map("resource_id")
  details      Json?
  ipAddress    String?  @map("ip_address")
  userAgent    String?  @map("user_agent")
  
  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@map("audit_logs")
}

// ============================================
// STUDENT MODEL
// ============================================
model Student {
  id           Int    @id @default(autoincrement()) @map("student_id")
  
  // Separated Name Fields
  lastName     String @map("last_name")
  firstName    String @map("first_name")
  middleInitial String? @map("middle_initial")
  
  program      String
  
  // Grade Level: GRADE_SCHOOL, JUNIOR_HIGH, SENIOR_HIGH, COLLEGE
  gradeLevel   String @map("grade_level")
  yearLevel    String @map("year_level")
  
  status       String

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  fees          StudentFees[]
  disbursements Disbursement[]
  scholarships  StudentScholarship[]

  @@map("students")
}

// ============================================
// STUDENT SCHOLARSHIP JUNCTION MODEL
// Many-to-Many relationship between Students and Scholarships
// ============================================
model StudentScholarship {
  id                Int       @id @default(autoincrement()) @map("student_scholarship_id")
  studentId         Int       @map("student_id")
  scholarshipId     Int       @map("scholarship_id")
  awardDate         DateTime  @map("award_date")
  startTerm         String    @map("start_term")
  endTerm           String    @map("end_term")
  grantAmount       Decimal   @map("grant_amount") @db.Decimal(10, 2)
  scholarshipStatus String    @map("scholarship_status") // Active, Completed, Suspended
  
  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  student     Student     @relation(fields: [studentId], references: [id], onDelete: Cascade)
  scholarship Scholarship @relation(fields: [scholarshipId], references: [id], onDelete: Restrict)

  @@unique([studentId, scholarshipId])
  @@map("student_scholarships")
}

// ============================================
// SCHOLARSHIP MODEL
// ============================================
model Scholarship {
  id               Int     @id @default(autoincrement()) @map("scholarship_id")
  scholarshipName  String  @map("scholarship_name")
  sponsor          String
  
  // Scholarship Type: PAED, CHED, LGU
  type             String
  
  // Scholarship Source: INTERNAL (within school), EXTERNAL (outside campus)
  source           String  @default("INTERNAL")
  
  amount           Decimal @db.Decimal(10, 2)
  requirements     String?
  status           String

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  students      StudentScholarship[]
  disbursements Disbursement[]

  @@map("scholarships")
}

// ============================================
// DISBURSEMENT MODEL
// Direct payment tracking for students
// ============================================
model Disbursement {
  id               Int      @id @default(autoincrement()) @map("disbursement_id")
  studentId        Int      @map("student_id")
  scholarshipId    Int      @map("scholarship_id")
  
  disbursementDate DateTime @map("disbursement_date")
  amount           Decimal  @db.Decimal(10, 2)
  term             String
  method           String
  remarks          String?

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  student     Student     @relation(fields: [studentId], references: [id], onDelete: Cascade)
  scholarship Scholarship @relation(fields: [scholarshipId], references: [id], onDelete: Restrict)

  @@map("disbursements")
}

// ============================================
// STUDENT FEES MODEL
// ============================================
model StudentFees {
  id        Int     @id @default(autoincrement()) @map("fees_id")
  studentId Int     @map("student_id")
  
  // Fee Breakdown
  tuitionFee       Decimal @map("tuition_fee") @db.Decimal(10, 2)
  otherFee         Decimal @map("other_fee") @db.Decimal(10, 2)
  miscellaneousFee Decimal @map("miscellaneous_fee") @db.Decimal(10, 2)
  laboratoryFee    Decimal @map("laboratory_fee") @db.Decimal(10, 2)
  
  // Subsidy Information
  amountSubsidy    Decimal @map("amount_subsidy") @db.Decimal(10, 2)
  percentSubsidy   Decimal @map("percent_subsidy") @db.Decimal(5, 2) // Calculated: (amountSubsidy / totalAmount) * 100
  
  // Academic Period
  term             String
  academicYear     String  @map("academic_year")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@map("student_fees")
}
