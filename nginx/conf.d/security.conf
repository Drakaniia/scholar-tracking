# ============================================================================
# SECURITY CONFIGURATION
# ============================================================================
# Additional security rules and blocking patterns
# Include this in http block: include /etc/nginx/conf.d/security.conf;
# ============================================================================

# -----------------------------------------------------------------------------
# BLOCK MALICIOUS USER AGENTS
# -----------------------------------------------------------------------------
map $http_user_agent $bad_bot {
    default 0;
    ~*^$ 1;                                    # Empty user agent
    ~*bot 0;                                   # Allow legitimate bots (Google, Bing)
    ~*(scanner|sqlmap|nikto|havij) 1;         # Security scanners
    ~*(masscan|nmap) 1;                        # Network scanners
    ~*(libwww-perl|python-requests|curl) 0;   # Allow common tools (set to 1 to block)
    ~*(Go-http-client|Java|wget) 0;           # Allow common clients
    ~*HTTrack 1;                               # Site copiers
    ~*MJ12bot 1;                               # Aggressive crawler
    ~*AhrefsBot 1;                             # SEO crawler (optional)
    ~*SemrushBot 1;                            # SEO crawler (optional)
    ~*DotBot 1;                                # SEO crawler
    ~*BLEXBot 1;                               # Aggressive crawler
}

# Block bad bots (add to server block)
# if ($bad_bot) {
#     return 403;
# }

# -----------------------------------------------------------------------------
# BLOCK BY REQUEST METHOD
# -----------------------------------------------------------------------------
# Only allow specific HTTP methods
map $request_method $bad_method {
    default 0;
    ~*^(GET|HEAD|POST|PUT|PATCH|DELETE|OPTIONS)$ 0;
    ~*.* 1;
}

# Block bad methods (add to server block)
# if ($bad_method) {
#     return 405;
# }

# -----------------------------------------------------------------------------
# BLOCK COMMON EXPLOITS
# -----------------------------------------------------------------------------
# SQL Injection patterns
map $args $sql_injection {
    default 0;
    ~*(union|select|insert|update|delete|drop|alter|create|truncate|exec|execute) 1;
    ~*(information_schema|mysql|pg_|sqlite) 1;
    ~*(char\(|concat\(|group_concat|load_file|into\s+outfile) 1;
    ~*(0x[0-9a-f]+|0b[01]+) 1;
}

# XSS patterns
map $args $xss_attack {
    default 0;
    ~*(<script|javascript:|vbscript:|expression\() 1;
    ~*(onmouseover|onerror|onclick|onload|onfocus|onblur) 1;
    ~*(document\.|window\.|alert\(|confirm\(|prompt\() 1;
}

# Path traversal
map $request_uri $path_traversal {
    default 0;
    ~*(\.\.\/|\.\.\\|%2e%2e%2f|%252e%252e%252f) 1;
    ~*(/etc/passwd|/etc/shadow|/proc/self) 1;
    ~*(boot\.ini|win\.ini|system32) 1;
}

# Block attacks (add to server block)
# if ($sql_injection) { return 403; }
# if ($xss_attack) { return 403; }
# if ($path_traversal) { return 403; }

# -----------------------------------------------------------------------------
# GEO BLOCKING (Requires ngx_http_geoip2_module)
# -----------------------------------------------------------------------------
# Example: Block specific countries
# geoip2 /usr/share/GeoIP/GeoLite2-Country.mmdb {
#     auto_reload 5m;
#     $geoip2_data_country_code country iso_code;
# }
#
# map $geoip2_data_country_code $allowed_country {
#     default yes;
#     CN no;  # China
#     RU no;  # Russia
#     # Add more as needed
# }

# -----------------------------------------------------------------------------
# REFERRER SPAM BLOCKING
# -----------------------------------------------------------------------------
map $http_referer $bad_referer {
    default 0;
    ~*(semalt|buttons-for-website|darodar|gambling|poker|casino) 1;
    ~*(free-share-buttons|social-buttons|icons-for-website) 1;
}

# Block bad referrers (add to server block)
# if ($bad_referer) {
#     return 403;
# }

# -----------------------------------------------------------------------------
# HOTLINK PROTECTION
# -----------------------------------------------------------------------------
# Prevent direct linking to your images from other sites
# Add to location block for images:
# valid_referers none blocked server_names *.scholarship.example.com;
# if ($invalid_referer) {
#     return 403;
# }

# -----------------------------------------------------------------------------
# REQUEST SIZE LIMITS
# -----------------------------------------------------------------------------
# These should be set in server/location blocks as needed
# client_max_body_size 10m;        # Max upload size
# client_body_buffer_size 128k;    # Body buffer
# client_header_buffer_size 1k;    # Header buffer

# -----------------------------------------------------------------------------
# SLOW LORIS PROTECTION
# -----------------------------------------------------------------------------
# client_body_timeout 10s;
# client_header_timeout 10s;
# keepalive_timeout 5s 5s;
# send_timeout 10s;

# -----------------------------------------------------------------------------
# FAIL2BAN INTEGRATION
# -----------------------------------------------------------------------------
# Log format for fail2ban parsing
# Create /etc/fail2ban/filter.d/nginx-http-auth.conf:
# [Definition]
# failregex = ^ \[error\] \d+#\d+: \*\d+ user "(?:[^"]+|.*?)":? (?:password mismatch|was not found in "[^"]*"), client: <HOST>, server: \S*, request: "\S+ \S+ HTTP/\d+\.\d+", host: "\S*"(?:, referrer: "\S*")?\s*$
# ignoreregex =
