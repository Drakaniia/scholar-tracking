# ============================================================================
# CACHING CONFIGURATION
# ============================================================================
# Multi-level caching strategies for optimal performance
# ============================================================================

# -----------------------------------------------------------------------------
# PROXY CACHE SETTINGS (Add to http block)
# -----------------------------------------------------------------------------
# Main proxy cache path
proxy_cache_path /var/cache/nginx/proxy_cache
                 levels=1:2
                 keys_zone=main_cache:100m
                 max_size=10g
                 inactive=60m
                 use_temp_path=off;

# Static assets cache (longer retention)
proxy_cache_path /var/cache/nginx/static_cache
                 levels=1:2
                 keys_zone=static_cache:50m
                 max_size=5g
                 inactive=7d
                 use_temp_path=off;

# API response cache (short-lived)
proxy_cache_path /var/cache/nginx/api_cache
                 levels=1:2
                 keys_zone=api_cache:20m
                 max_size=1g
                 inactive=10m
                 use_temp_path=off;

# Microcache for dynamic pages (very short-lived)
proxy_cache_path /var/cache/nginx/microcache
                 levels=1:2
                 keys_zone=microcache:10m
                 max_size=500m
                 inactive=1m
                 use_temp_path=off;

# -----------------------------------------------------------------------------
# CACHE KEY DEFINITIONS
# -----------------------------------------------------------------------------
# Standard cache key
proxy_cache_key "$scheme$request_method$host$request_uri";

# Cache key with cookies for user-specific content
# proxy_cache_key "$scheme$request_method$host$request_uri$cookie_session";

# -----------------------------------------------------------------------------
# CACHE BYPASS RULES
# -----------------------------------------------------------------------------
# Don't cache if these conditions are met
map $request_uri $skip_cache {
    default 0;
    ~*/api/ 1;           # Skip API endpoints by default
    ~*/admin 1;          # Skip admin pages
    ~*/dashboard 1;      # Skip dashboard
    ~*\?.*nocache 1;     # Skip if nocache param present
}

# Bypass cache for logged-in users
map $http_cookie $cache_bypass {
    default 0;
    ~*session 1;
    ~*auth_token 1;
    ~*logged_in 1;
}

# -----------------------------------------------------------------------------
# STATIC ASSETS CACHING (Add to server block)
# -----------------------------------------------------------------------------
# Use this location block for static assets with aggressive caching

# Next.js static files with immutable caching
# location /_next/static/ {
#     proxy_cache static_cache;
#     proxy_cache_valid 200 365d;
#     proxy_cache_use_stale error timeout updating http_500 http_502 http_503 http_504;
#     proxy_cache_revalidate on;
#     proxy_cache_background_update on;
#
#     # Browser caching
#     expires 1y;
#     add_header Cache-Control "public, immutable";
#     add_header X-Cache-Status $upstream_cache_status;
#
#     proxy_pass http://nextjs_app;
# }

# -----------------------------------------------------------------------------
# API CACHING EXAMPLE
# -----------------------------------------------------------------------------
# Cache read-only API endpoints

# location /api/public/ {
#     proxy_cache api_cache;
#     proxy_cache_valid 200 5m;
#     proxy_cache_valid 404 1m;
#     proxy_cache_methods GET HEAD;
#     proxy_cache_use_stale error timeout updating http_500 http_502 http_503 http_504;
#
#     # Cache variations by query string
#     proxy_cache_key "$scheme$request_method$host$uri$is_args$args";
#
#     # Bypass cache for authenticated requests
#     proxy_cache_bypass $http_authorization;
#     proxy_no_cache $http_authorization;
#
#     add_header X-Cache-Status $upstream_cache_status;
#
#     proxy_pass http://nextjs_app;
# }

# -----------------------------------------------------------------------------
# MICROCACHING FOR DYNAMIC PAGES
# -----------------------------------------------------------------------------
# Cache dynamic pages for 1 second to handle traffic spikes

# location / {
#     # Microcache for 1 second
#     proxy_cache microcache;
#     proxy_cache_valid 200 1s;
#     proxy_cache_lock on;
#     proxy_cache_lock_timeout 5s;
#     proxy_cache_lock_age 5s;
#
#     # Bypass for logged-in users
#     proxy_cache_bypass $cache_bypass;
#     proxy_no_cache $cache_bypass;
#
#     # Serve stale content while updating
#     proxy_cache_use_stale updating;
#     proxy_cache_background_update on;
#
#     add_header X-Cache-Status $upstream_cache_status;
#
#     proxy_pass http://nextjs_app;
# }

# -----------------------------------------------------------------------------
# FASTCGI CACHE (For PHP applications - reference only)
# -----------------------------------------------------------------------------
# fastcgi_cache_path /var/cache/nginx/fastcgi
#                    levels=1:2
#                    keys_zone=fastcgi_cache:100m
#                    max_size=10g
#                    inactive=60m;
#
# fastcgi_cache_key "$scheme$request_method$host$request_uri";

# -----------------------------------------------------------------------------
# BROWSER CACHE CONTROL HEADERS
# -----------------------------------------------------------------------------
# Map file types to cache durations
map $sent_http_content_type $cache_control {
    default                         "no-cache";
    text/html                       "no-cache, no-store, must-revalidate";
    text/css                        "public, max-age=31536000, immutable";
    application/javascript          "public, max-age=31536000, immutable";
    application/x-javascript        "public, max-age=31536000, immutable";
    image/svg+xml                   "public, max-age=2592000";
    image/png                       "public, max-age=2592000";
    image/jpeg                      "public, max-age=2592000";
    image/gif                       "public, max-age=2592000";
    image/webp                      "public, max-age=2592000";
    image/x-icon                    "public, max-age=31536000";
    font/woff                       "public, max-age=31536000, immutable";
    font/woff2                      "public, max-age=31536000, immutable";
    font/eot                        "public, max-age=31536000, immutable";
    font/ttf                        "public, max-age=31536000, immutable";
    application/json                "no-cache, no-store, must-revalidate";
}

# Apply cache control (in server block)
# add_header Cache-Control $cache_control;

# -----------------------------------------------------------------------------
# CACHE PURGING (Requires ngx_cache_purge module)
# -----------------------------------------------------------------------------
# location ~ /purge(/.*) {
#     allow 127.0.0.1;
#     allow 10.0.0.0/8;
#     deny all;
#     proxy_cache_purge main_cache "$scheme$request_method$host$1";
# }

# -----------------------------------------------------------------------------
# CACHE STATUS HEADER VALUES
# -----------------------------------------------------------------------------
# X-Cache-Status values:
# - MISS: Response not in cache, fetched from upstream
# - HIT: Response served from cache
# - EXPIRED: Cache entry expired, fetched from upstream
# - STALE: Stale response served (upstream unavailable)
# - UPDATING: Stale response served, cache updating in background
# - REVALIDATED: Response revalidated with upstream
# - BYPASS: Cache bypassed due to cache_bypass rules
